<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Orders - Admin Panel</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">üõçÔ∏è ShopHub Admin</a>
            
            <ul class="nav-menu">
                <li><a href="index.html">Storefront</a></li>
                <!-- Admin links will be inserted here dynamically by api.js -->
            </ul>
            
            <div class="nav-icons">
                <a href="cart.html" class="nav-icon">
                    üõí
                    <span id="cart-badge" class="cart-badge" style="display: none;">0</span>
                </a>
                <a href="login.html" id="login-link" class="nav-icon">üë§</a>
                <a href="#" id="user-link" class="nav-icon" style="display: none;" title="Profile">üëë</a>
                <button id="logout-btn" class="nav-icon" style="display: none; background: none; border: none; color: white; cursor: pointer;">Logout</button>
            </div>
            
            <button class="mobile-menu-btn">‚ò∞</button>
        </div>
    </nav>

    <!-- Admin Welcome Banner -->
    <div style="background: linear-gradient(135deg, #ffc107, #ff9800); padding: 20px; text-align: center;">
        <h2 style="margin: 0; color: #000;">üëë Admin Panel</h2>
        <p style="margin: 5px 0 0 0; color: #333;" id="admin-email">Loading...</p>
    </div>

    <!-- Admin Orders Section -->
    <div class="container">
        <div class="admin-container" style="max-width: 100%;">
            <div class="admin-header">
                <div>
                    <h1 class="section-title">Manage Orders</h1>
                    <p class="section-subtitle">View and update all customer orders</p>
                </div>
                <a href="admin-add-product.html" class="btn-secondary">
                    ‚ûï Add Product
                </a>
            </div>

            <!-- Admin Authentication -->
            <div class="alert alert-info mb-20">
                <span>üîê</span>
                <span><strong>n8n Admin Password:</strong> Enter your admin password (set in n8n workflow) to load orders.</span>
            </div>

            <div style="background: var(--white); padding: 25px; border-radius: 12px; border: 1px solid var(--border-gray); margin-bottom: 30px;">
                <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <label class="form-label">Admin Password (for n8n)</label>
                        <input type="password" id="admin-token" class="form-input" placeholder="Enter n8n admin password">
                        <small style="color: var(--text-light); font-size: 0.85em;">
                            üí° This will be remembered for this session
                        </small>
                    </div>
                    <button onclick="loadAllOrders()" class="btn-primary" style="width: auto;">
                        Load Orders
                    </button>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div id="stats-container" style="display: none; margin-bottom: 30px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="background: var(--light-gray); padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: var(--primary-black);" id="stat-total">0</div>
                        <div style="color: var(--text-light);">Total Orders</div>
                    </div>
                    <div style="background: #fff3cd; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #856404;" id="stat-pending">0</div>
                        <div style="color: #856404;">Pending</div>
                    </div>
                    <div style="background: #d4edda; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #155724;" id="stat-shipped">0</div>
                        <div style="color: #155724;">Shipped</div>
                    </div>
                    <div style="background: #d1ecf1; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: var(--primary-black);" id="stat-revenue">$0</div>
                        <div style="color: var(--text-light);">Total Revenue</div>
                    </div>
                </div>
            </div>

            <!-- Filter Section -->
            <div id="filters-container" style="display: none; margin-bottom: 30px;">
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                    <label style="font-weight: 600;">Filter by Status:</label>
                    <select id="status-filter" class="form-select" style="width: 200px;">
                        <option value="">All Orders</option>
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="processing">Processing</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    
                    <label style="font-weight: 600; margin-left: 20px;">Sort by:</label>
                    <select id="sort-filter" class="form-select" style="width: 200px;">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="amount-high">Amount: High to Low</option>
                        <option value="amount-low">Amount: Low to High</option>
                    </select>
                </div>
            </div>

            <!-- Orders Container -->
            <div id="orders-container">
                <div class="empty-state">
                    <div class="empty-state-icon">üîê</div>
                    <h2>Enter Admin Password</h2>
                    <p>Enter your n8n admin password above to view and manage orders.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="index.html">Home</a>
                <a href="products.html">Products</a>
            </div>
            <p>&copy; 2024 ShopHub. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="api.js"></script>
    <script>
        let allOrders = [];
        let currentAdminToken = '';

        // Display admin info
        async function displayAdminInfo() {
            const user = await getCurrentUser();
            if (user) {
                document.getElementById('admin-email').textContent = `Logged in as: ${user.email}`;
            }
        }

        // Load all orders
        async function loadAllOrders() {
            const adminToken = document.getElementById('admin-token').value.trim();

            if (!adminToken) {
                showAlert('Please enter admin password', 'error');
                return;
            }

            // Save token for future use
            saveAdminToken(adminToken);
            currentAdminToken = adminToken;
            
            const container = document.getElementById('orders-container');
            showLoading('orders-container');

            try {
                const response = await fetch(`${API_ENDPOINTS.ADMIN_GET_ALL_ORDERS}?admin_token=${adminToken}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch orders');
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || 'Invalid admin password');
                }

                allOrders = result.orders || [];

                document.getElementById('stats-container').style.display = 'block';
                document.getElementById('filters-container').style.display = 'block';

                updateStatistics();
                displayOrders(allOrders);

                showAlert('Orders loaded successfully', 'success');

            } catch (error) {
                console.error('Error loading orders:', error);
                container.innerHTML = `
                    <div class="alert alert-error">
                        <span>‚ö†Ô∏è</span>
                        <span>Failed to load orders: ${error.message}</span>
                    </div>
                `;
                
                document.getElementById('stats-container').style.display = 'none';
                document.getElementById('filters-container').style.display = 'none';
            }
        }

        // Update statistics
        function updateStatistics() {
            const totalOrders = allOrders.length;
            const pendingOrders = allOrders.filter(o => o.status === 'pending').length;
            const shippedOrders = allOrders.filter(o => o.status === 'shipped' || o.status === 'delivered').length;
            const totalRevenue = allOrders.reduce((sum, order) => sum + parseFloat(order.total_amount), 0);

            document.getElementById('stat-total').textContent = totalOrders;
            document.getElementById('stat-pending').textContent = pendingOrders;
            document.getElementById('stat-shipped').textContent = shippedOrders;
            document.getElementById('stat-revenue').textContent = formatPrice(totalRevenue);
        }

        // Display orders
        function displayOrders(orders) {
            const container = document.getElementById('orders-container');

            if (!orders || orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h2>No Orders Found</h2>
                        <p>There are no orders matching your filters.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = orders.map(order => {
                const statusEmoji = {
                    pending: '‚è≥',
                    confirmed: '‚úì',
                    processing: 'üì¶',
                    shipped: 'üöö',
                    delivered: '‚úÖ',
                    cancelled: '‚ùå'
                };

                const itemCount = order.items ? order.items.length : 0;

                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <h3 class="order-number">Order #${order.order_number}</h3>
                                <p style="color: var(--text-light); font-size: 0.9em;">
                                    ${formatDate(order.created_at)}
                                </p>
                            </div>
                            <span class="order-status status-${order.status}">
                                ${statusEmoji[order.status] || 'üìã'} ${order.status}
                            </span>
                        </div>

                        <div class="order-info">
                            <div class="order-info-item">
                                <strong>Customer</strong>
                                ${order.shipping_address.full_name || 'N/A'}
                            </div>
                            <div class="order-info-item">
                                <strong>Total Amount</strong>
                                ${formatPrice(order.total_amount)}
                            </div>
                            <div class="order-info-item">
                                <strong>Items</strong>
                                ${itemCount} ${itemCount === 1 ? 'item' : 'items'}
                            </div>
                            <div class="order-info-item">
                                <strong>Phone</strong>
                                ${order.phone_number}
                            </div>
                            <div class="order-info-item">
                                <strong>City</strong>
                                ${order.shipping_address.city}
                            </div>
                            <div class="order-info-item">
                                <strong>Payment</strong>
                                ${order.payment_method || 'COD'}
                            </div>
                        </div>

                        ${order.items && order.items.length > 0 ? `
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-gray);">
                                <strong style="display: block; margin-bottom: 10px;">Order Items:</strong>
                                ${order.items.slice(0, 2).map(item => `
                                    <div style="display: flex; justify-content: space-between; padding: 8px; background: var(--light-gray); border-radius: 5px; margin-bottom: 5px; font-size: 0.9em;">
                                        <span>${item.product_name || item.name} √ó ${item.quantity}</span>
                                        <span style="font-weight: 600;">${formatPrice(item.price_at_purchase * item.quantity)}</span>
                                    </div>
                                `).join('')}
                                ${order.items.length > 2 ? `<p style="color: var(--text-light); font-size: 0.85em; margin-top: 5px;">+ ${order.items.length - 2} more items</p>` : ''}
                            </div>
                        ` : ''}

                        <div class="admin-actions mt-20">
                            <a href="admin-update-order.html?order_id=${order.id}&order_number=${order.order_number}" class="btn-primary" style="display: inline-block; width: auto; text-decoration: none;">
                                Update Status
                            </a>
                            <button onclick="viewOrderDetails('${order.id}')" class="btn-secondary">
                                View Full Details
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter and sort orders
        function filterAndSortOrders() {
            const statusFilter = document.getElementById('status-filter').value;
            const sortFilter = document.getElementById('sort-filter').value;

            let filtered = [...allOrders];

            if (statusFilter) {
                filtered = filtered.filter(order => order.status === statusFilter);
            }

            switch(sortFilter) {
                case 'oldest':
                    filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    break;
                case 'amount-high':
                    filtered.sort((a, b) => b.total_amount - a.total_amount);
                    break;
                case 'amount-low':
                    filtered.sort((a, b) => a.total_amount - b.total_amount);
                    break;
                case 'newest':
                default:
                    filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
            }

            displayOrders(filtered);
        }

        function viewOrderDetails(orderId) {
            window.open(`order-details.html?order_id=${orderId}`, '_blank');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            displayAdminInfo();
            
            document.getElementById('status-filter').addEventListener('change', filterAndSortOrders);
            document.getElementById('sort-filter').addEventListener('change', filterAndSortOrders);

            document.getElementById('admin-token').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loadAllOrders();
                }
            });
        });
    </script>
</body>
</html>