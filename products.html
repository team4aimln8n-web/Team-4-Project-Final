<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - ShopHub</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="chatbot.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">üõçÔ∏è ShopHub</a>
            
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="products.html">Products</a></li>
                <li><a href="orders.html">My Orders</a></li>
            </ul>
            
            <div class="nav-icons">
                <a href="cart.html" class="nav-icon">
                    üõí
                    <span id="cart-badge" class="cart-badge" style="display: none;">0</span>
                </a>
                <a href="login.html" id="login-link" class="nav-icon">üë§</a>
                <a href="#" id="user-link" class="nav-icon" style="display: none;" title="Profile">üë§</a>
                <button id="logout-btn" class="nav-icon" style="display: none; background: none; border: none; color: white; cursor: pointer;">Logout</button>
            </div>
            
            <button class="mobile-menu-btn">‚ò∞</button>
        </div>
    </nav>

    <!-- Products Section -->
    <div class="container">
        <h1 class="section-title">All Products</h1>
        <p class="section-subtitle">Browse our complete collection</p>

        <!-- Filter Section (Optional - can be enhanced later) -->
        <div style="margin-bottom: 30px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
            <label style="font-weight: 600;">Filter by Category:</label>
            <select id="category-filter" class="form-select" style="width: 200px;">
                <option value="">All Categories</option>
            </select>
            
            <label style="font-weight: 600; margin-left: 20px;">Sort by:</label>
            <select id="sort-filter" class="form-select" style="width: 200px;">
                <option value="newest">Newest First</option>
                <option value="price-low">Price: Low to High</option>
                <option value="price-high">Price: High to Low</option>
                <option value="name">Name: A to Z</option>
            </select>
        </div>
        
        <div id="products-container" class="product-grid">
            <!-- Products will be loaded here dynamically -->
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="index.html">Home</a>
                <a href="products.html">Products</a>
                <a href="orders.html">My Orders</a>
                <a href="cart.html">Cart</a>
                <a href="login.html">Login</a>
            </div>
            <p>&copy; 2024 ShopHub. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- Scripts - CRITICAL: Load api.js first and WAIT for it -->
<script src="api.js"></script>

<!-- Products Loading Script - Runs IMMEDIATELY after api.js -->
<script>
console.log('üõçÔ∏è Products script loaded');

let allProducts = [];

// Load all products
async function loadProducts() {
    console.log('üîÑ loadProducts() called');
    
    const container = document.getElementById('products-container');
    

    let renderedFromStatic = false;

/* --------------------------------------------------
   1Ô∏è‚É£ STATIC BOOTSTRAP (INSTANT)
-------------------------------------------------- */
try {
    const staticResponse = await fetch('./data/products.json');
    if (staticResponse.ok) {
        allProducts = await staticResponse.json();
        displayProducts(allProducts);
        populateCategoryFilter();
        renderedFromStatic = true;
        console.log('‚ö° Static products rendered');
    }
} catch (e) {
    console.warn('‚ö†Ô∏è Static products JSON not available');
}


    /* --------------------------------------------------
   2Ô∏è‚É£ LIVE DATA (CACHED)
-------------------------------------------------- */
try {
    let attempts = 0;
    while (typeof API_ENDPOINTS === 'undefined' && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
    }

    if (typeof API_ENDPOINTS === 'undefined') {
        throw new Error('API configuration not loaded');
    }

    console.log('üì° Fetching products from:', API_ENDPOINTS.GET_PRODUCTS);

    allProducts = await fetchWithCache(API_ENDPOINTS.GET_PRODUCTS);

    displayProducts(allProducts);
    populateCategoryFilter();

    console.log('‚úÖ Live products rendered');

} catch (error) {
    console.error('‚ùå Error loading products:', error);

    // ‚ùó Only show error if NOTHING rendered yet
    if (!renderedFromStatic) {
        showError(container, error, 'products');
    }
}


}


// Display products
function displayProducts(products) {
    const container = document.getElementById('products-container');

    if (products.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
                <div class="empty-state-icon">üì¶</div>
                <h2>No Products Found</h2>
                <p>Try adjusting your filters or check back later.</p>
            </div>
        `;
        return;
    }

    container.innerHTML = products.map(product => {
        const imageUrl = product.images && product.images.length > 0 
            ? product.images.find(img => img.is_primary)?.url || product.images[0].url
            : 'https://via.placeholder.com/280x280?text=No+Image';
        
        const isOutOfStock = product.stock_quantity <= 0;

        return `
            <div class="product-card" onclick="window.location.href='product-details.html?id=${product.id}'">
                <img src="${imageUrl}" alt="${product.name}" class="product-image" onerror="this.src='https://via.placeholder.com/280x280?text=No+Image'">
                <div class="product-info">
                    <h3 class="product-name">${product.name}</h3>
                    <p class="product-description">${truncateText(product.description || '', 80)}</p>
                    <p class="product-price">${formatPrice(product.price)}</p>
                    <p class="product-stock ${isOutOfStock ? 'out-of-stock' : ''}">
                        ${isOutOfStock ? 'Out of Stock' : `In Stock: ${product.stock_quantity}`}
                    </p>
                    <button 
                        class="btn-primary" 
                        onclick="event.stopPropagation(); addToCart('${product.id}')"
                        ${isOutOfStock ? 'disabled' : ''}
                    >
                        ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    console.log('‚úÖ Products rendered to page');
}

// Populate category filter dropdown
function populateCategoryFilter() {
    const categoryFilter = document.getElementById('category-filter');
    if (!categoryFilter) return;
    
    const categories = [...new Set(allProducts.map(p => p.category).filter(c => c))];
    
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryFilter.appendChild(option);
    });
    
    console.log('‚úÖ Category filter populated with', categories.length, 'categories');
}

// Filter and sort products
function filterAndSortProducts() {
    const categoryFilter = document.getElementById('category-filter');
    const sortFilter = document.getElementById('sort-filter');
    
    if (!categoryFilter || !sortFilter) return;
    
    const categoryValue = categoryFilter.value;
    const sortValue = sortFilter.value;

    let filtered = [...allProducts];

    // Filter by category
    if (categoryValue) {
        filtered = filtered.filter(p => p.category === categoryValue);
    }

    // Sort products
    switch(sortValue) {
        case 'price-low':
            filtered.sort((a, b) => a.price - b.price);
            break;
        case 'price-high':
            filtered.sort((a, b) => b.price - a.price);
            break;
        case 'name':
            filtered.sort((a, b) => a.name.localeCompare(b.name));
            break;
        case 'newest':
        default:
            filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            break;
    }

    displayProducts(filtered);
}

// Execute immediately when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìÑ DOM loaded, loading products...');
        loadProducts();
        
        // Attach filter event listeners
        const categoryFilter = document.getElementById('category-filter');
        const sortFilter = document.getElementById('sort-filter');
        
        if (categoryFilter) {
            categoryFilter.addEventListener('change', filterAndSortProducts);
        }
        if (sortFilter) {
            sortFilter.addEventListener('change', filterAndSortProducts);
        }
    });
} else {
    // DOM already loaded
    console.log('üìÑ DOM already loaded, loading products immediately...');
    loadProducts();
    
    // Attach filter event listeners
    const categoryFilter = document.getElementById('category-filter');
    const sortFilter = document.getElementById('sort-filter');
    
    if (categoryFilter) {
        categoryFilter.addEventListener('change', filterAndSortProducts);
    }
    if (sortFilter) {
        sortFilter.addEventListener('change', filterAndSortProducts);
    }
}

// ALSO try to load after a short delay as backup
setTimeout(() => {
    const container = document.getElementById('products-container');
    // Only load if container is still empty or showing loading
    if (container && (container.innerHTML.includes('spinner') || container.children.length === 0)) {
        console.log('‚è∞ Backup: Loading products after timeout');
        loadProducts();
    }
}, 1500);
</script>

<!-- Load chatbot LAST - it won't interfere now -->
<script src="chatbot.js"></script>
</body>
</html>