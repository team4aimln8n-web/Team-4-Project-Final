<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details - ShopHub</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="chatbot.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">üõçÔ∏è ShopHub</a>
            
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="products.html">Products</a></li>
                <li><a href="orders.html">My Orders</a></li>
            </ul>
            
            <div class="nav-icons">
                <a href="cart.html" class="nav-icon">
                    üõí
                    <span id="cart-badge" class="cart-badge" style="display: none;">0</span>
                </a>
                <a href="login.html" id="login-link" class="nav-icon">üë§</a>
                <a href="#" id="user-link" class="nav-icon" style="display: none;" title="Profile">üë§</a>
                <button id="logout-btn" class="nav-icon" style="display: none; background: none; border: none; color: white; cursor: pointer;">Logout</button>
            </div>
            
            <button class="mobile-menu-btn">‚ò∞</button>
        </div>
    </nav>

    <!-- Order Details Section -->
    <div class="container">
        <div style="margin-bottom: 20px;">
            <a href="orders.html" class="btn-secondary" style="display: inline-block; width: auto;">‚Üê Back to Orders</a>
        </div>

        <h1 class="section-title">Order Details</h1>

        <div id="order-details-container">
            <!-- Order details will be loaded here -->
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="index.html">Home</a>
                <a href="products.html">Products</a>
                <a href="orders.html">My Orders</a>
                <a href="cart.html">Cart</a>
                <a href="login.html">Login</a>
            </div>
            <p>&copy; 2024 ShopHub. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- Scripts - CRITICAL: Load api.js first and WAIT for it -->
<script src="api.js"></script>

<!-- Order Details Loading Script - Runs IMMEDIATELY after api.js -->
<script>
console.log('üìã Order Details script loaded');

// Load order details
async function loadOrderDetails() {
    console.log('üîÑ loadOrderDetails() called');
    
    if (!checkAuth()) return;

    const orderId = getUrlParameter('order_id');
    const container = document.getElementById('order-details-container');
    
    if (!orderId) {
        container.innerHTML = `
            <div class="alert alert-error">
                <span>‚ö†Ô∏è</span>
                <span>Order ID not found. Please select an order from the orders page.</span>
            </div>
        `;
        return;
    }

    // Show loading spinner - use inline HTML to avoid function conflicts
    container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

    try {
        // Wait for API_ENDPOINTS to be available
        let attempts = 0;
        while (typeof API_ENDPOINTS === 'undefined' && attempts < 50) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
        }
        
        if (typeof API_ENDPOINTS === 'undefined') {
            throw new Error('API_ENDPOINTS not available');
        }
        
        console.log('üì° Fetching order details from:', API_ENDPOINTS.GET_ORDER_DETAILS);
        
        const response = await fetch(`${API_ENDPOINTS.GET_ORDER_DETAILS}?order_id=${orderId}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const order = await response.json();

        if (!order || !order.id) {
            throw new Error('Order not found');
        }

        console.log('‚úÖ Order details loaded:', order);
        
        displayOrderDetails(order);

    } catch (error) { console.error('‚ùå Error loading products:', error); showError(container, error, 'orderDetails'); }
}

// Display order details
function displayOrderDetails(order) {
    const container = document.getElementById('order-details-container');

    const orderTotal = order.items ? 
        order.items.reduce((sum, item) => sum + (item.price_at_purchase * item.quantity), 0) : 
        order.total_amount;

    const statusEmoji = {
        pending: '‚è≥',
        confirmed: '‚úì',
        processing: 'üì¶',
        shipped: 'üöö',
        delivered: '‚úÖ',
        cancelled: '‚ùå'
    };

    const statusMessage = {
        pending: 'Your order has been received and is awaiting confirmation.',
        confirmed: 'Your order has been confirmed and will be processed soon.',
        processing: 'Your order is being prepared for shipment.',
        shipped: 'Your order has been shipped and is on its way!',
        delivered: 'Your order has been delivered. Thank you for shopping with us!',
        cancelled: 'This order has been cancelled.'
    };

    container.innerHTML = `
        <!-- Order Header -->
        <div class="order-card">
            <div class="order-header">
                <div>
                    <h2 class="order-number">Order #${order.order_number}</h2>
                    <p style="color: var(--text-light); font-size: 0.95em;">
                        Placed on ${formatDate(order.created_at)}
                    </p>
                </div>
                <span class="order-status status-${order.status}">
                    ${statusEmoji[order.status] || 'üìã'} ${order.status}
                </span>
            </div>

            <div class="alert alert-info mt-20">
                <span>${statusEmoji[order.status] || '‚ÑπÔ∏è'}</span>
                <span>${statusMessage[order.status] || 'Order status updated.'}</span>
            </div>
        </div>

        <!-- Order Items -->
        ${order.items && order.items.length > 0 ? `
            <div class="order-card mt-20">
                <h3 style="margin-bottom: 20px; color: var(--primary-black);">Order Items (${order.items.length})</h3>
                
                ${order.items.map(item => {
                    const imageUrl = item.image_url || 'https://via.placeholder.com/80x80?text=No+Image';
                    const subtotal = item.price_at_purchase * item.quantity;

                    return `
                        <div class="order-item">
                            <img src="${imageUrl}" alt="${item.product_name || item.name}" class="order-item-image" onerror="this.src='https://via.placeholder.com/80x80?text=No+Image'">
                            
                            <div class="order-item-details">
                                <h4 class="order-item-name">${item.product_name || item.name}</h4>
                                <p class="order-item-price">
                                    ${formatPrice(item.price_at_purchase)} √ó ${item.quantity}
                                </p>
                            </div>

                            <div style="text-align: right; font-weight: bold; font-size: 1.1em;">
                                ${formatPrice(subtotal)}
                            </div>
                        </div>
                    `;
                }).join('')}

                <div style="border-top: 2px solid var(--border-gray); padding-top: 20px; margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-size: 1.1em;">Subtotal:</span>
                        <span style="font-size: 1.1em;">${formatPrice(orderTotal)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span style="font-size: 1.1em;">Shipping:</span>
                        <span style="font-size: 1.1em; color: var(--success-green); font-weight: 600;">FREE</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 1.4em; font-weight: bold;">
                        <span>Total:</span>
                        <span>${formatPrice(orderTotal)}</span>
                    </div>
                </div>
            </div>
        ` : ''}

        <!-- Two Column Layout for Shipping and Payment -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
            <!-- Shipping Information -->
            <div class="order-card">
                <h3 style="margin-bottom: 20px; color: var(--primary-black);">üìç Shipping Address</h3>
                <div style="line-height: 1.8;">
                    ${order.shipping_address.full_name ? `<p><strong>${order.shipping_address.full_name}</strong></p>` : ''}
                    <p>${order.shipping_address.street}</p>
                    <p>${order.shipping_address.city}${order.shipping_address.state ? ', ' + order.shipping_address.state : ''}</p>
                    <p>${order.shipping_address.postal_code}</p>
                    <p style="margin-top: 10px;"><strong>Phone:</strong> ${order.phone_number}</p>
                    ${order.notes ? `<p style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-gray);"><strong>Delivery Notes:</strong><br>${order.notes}</p>` : ''}
                </div>
            </div>

            <!-- Payment Information -->
            <div class="order-card">
                <h3 style="margin-bottom: 20px; color: var(--primary-black);">üíµ Payment Information</h3>
                <div style="line-height: 1.8;">
                    <p><strong>Payment Method:</strong> Cash on Delivery (COD)</p>
                    <p style="color: var(--text-light); margin-top: 10px;">
                        You will pay <strong style="color: var(--primary-black); font-size: 1.2em;">${formatPrice(orderTotal)}</strong> in cash when your order is delivered.
                    </p>
                    
                    ${order.status === 'delivered' ? `
                        <div class="alert alert-success mt-20">
                            <span>‚úÖ</span>
                            <span>Payment completed on delivery</span>
                        </div>
                    ` : `
                        <div class="alert alert-info mt-20">
                            <span>‚ÑπÔ∏è</span>
                            <span>Payment will be collected upon delivery</span>
                        </div>
                    `}
                </div>
            </div>
        </div>

        <!-- Order Timeline (Optional Enhancement) -->
        <div class="order-card mt-20">
            <h3 style="margin-bottom: 20px; color: var(--primary-black);">üìã Order Timeline</h3>
            <div style="position: relative; padding-left: 40px;">
                <div style="position: absolute; left: 12px; top: 0; bottom: 0; width: 2px; background: var(--border-gray);"></div>
                
                <div style="position: relative; margin-bottom: 30px;">
                    <div style="position: absolute; left: -33px; width: 24px; height: 24px; border-radius: 50%; background: var(--success-green); border: 3px solid white; box-shadow: 0 0 0 2px var(--success-green);"></div>
                    <strong>Order Placed</strong>
                    <p style="color: var(--text-light); font-size: 0.9em;">${formatDate(order.created_at)}</p>
                </div>

                ${order.status === 'confirmed' || order.status === 'processing' || order.status === 'shipped' || order.status === 'delivered' ? `
                    <div style="position: relative; margin-bottom: 30px;">
                        <div style="position: absolute; left: -33px; width: 24px; height: 24px; border-radius: 50%; background: var(--success-green); border: 3px solid white; box-shadow: 0 0 0 2px var(--success-green);"></div>
                        <strong>Order Confirmed</strong>
                        <p style="color: var(--text-light); font-size: 0.9em;">Your order has been confirmed</p>
                    </div>
                ` : `
                    <div style="position: relative; margin-bottom: 30px; opacity: 0.5;">
                        <div style="position: absolute; left: -33px; width: 24px; height: 24px; border-radius: 50%; background: var(--border-gray); border: 3px solid white;"></div>
                        <strong>Order Confirmation</strong>
                        <p style="color: var(--text-light); font-size: 0.9em;">Pending confirmation</p>
                    </div>
                `}

                ${order.status === 'processing' || order.status === 'shipped' || order.status === 'delivered' ? `
                    <div style="position: relative; margin-bottom: 30px;">
                        <div style="position: absolute; left: -33px; width: 24px; height: 24px; border-radius: 50%; background: var(--success-green); border: 3px solid white; box-shadow: 0 0 0 2px var(--success-green);"></div>
                        <strong>Processing</strong>
                        <p style="color: var(--text-light); font-size: 0.9em;">Order is being prepared</p>
                    </div>
                ` : `
                    <div style="position: relative; margin-bottom: 30px; opacity: 0.5;">
                        <div style="position: absolute; left: -33px; width: 24px; height: 24px; border-radius: 50%; background: var(--border-gray); border: 3px solid white;"></div>
                        <strong>Processing</strong>
                        <p style="color: var(--text-light); font-size: 0.9em;">Awaiting processing</p>
                    </div>
                `}

                ${order.status === 'shipped' || order.status === 'delivered' ? `
                    <div style="position: relative; margin-bottom: 30px;">
                        <div style="position: absolute; left: -33px; width: 24px; height: 24px; border-radius: 50%; background: var(--success-green); border: 3px solid white; box-shadow: 0 0 0 2px var(--success-green);"></div>
                        <strong>Shipped</strong>
                        <p style="color: var(--text-light); font-size: 0.9em;">Order is on the way</p>
                    </div>
                ` : `
                    <div style="position: relative; margin-bottom: 30px; opacity: 0.5;">
                        <div style="position: absolute; left: -33px; width: 24px; height: 24px; border-radius: 50%; background: var(--border-gray); border: 3px solid white;"></div>
                        <strong>Shipped</strong>
                        <p style="color: var(--text-light); font-size: 0.9em;">Not yet shipped</p>
                    </div>
                `}

                ${order.status === 'delivered' ? `
                    <div style="position: relative;">
                        <div style="position: absolute; left: -33px; width: 24px; height: 24px; border-radius: 50%; background: var(--success-green); border: 3px solid white; box-shadow: 0 0 0 2px var(--success-green);"></div>
                        <strong>Delivered</strong>
                        <p style="color: var(--text-light); font-size: 0.9em;">Order delivered successfully</p>
                    </div>
                ` : `
                    <div style="position: relative; opacity: 0.5;">
                        <div style="position: absolute; left: -33px; width: 24px; height: 24px; border-radius: 50%; background: var(--border-gray); border: 3px solid white;"></div>
                        <strong>Delivered</strong>
                        <p style="color: var(--text-light); font-size: 0.9em;">Pending delivery</p>
                    </div>
                `}
            </div>
        </div>
    `;
    
    console.log('‚úÖ Order details rendered to page');
}

// Execute immediately when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìÑ DOM loaded, loading order details...');
        loadOrderDetails();
    });
} else {
    // DOM already loaded
    console.log('üìÑ DOM already loaded, loading order details immediately...');
    loadOrderDetails();
}

// ALSO try to load after a short delay as backup
setTimeout(() => {
    const container = document.getElementById('order-details-container');
    // Only load if container is still empty or showing loading
    if (container && (container.innerHTML.includes('spinner') || container.children.length === 0)) {
        console.log('‚è∞ Backup: Loading order details after timeout');
        loadOrderDetails();
    }
}, 1500);
</script>

<!-- Load chatbot LAST - it won't interfere now -->
<script src="chatbot.js"></script>
</body>
</html>