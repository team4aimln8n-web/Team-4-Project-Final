<!-- Replace the entire checkout.html content with this enhanced version -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - ShopHub</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="chatbot.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Full Page Loading Overlay -->
    <div id="page-loading" class="page-loading-overlay">
        <div class="loading-spinner-large"></div>
        <div class="loading-text">Loading your cart...</div>
        <div class="loading-subtext">Please wait while we fetch your items</div>
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">üõçÔ∏è ShopHub</a>
            
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="products.html">Products</a></li>
                <li><a href="orders.html">My Orders</a></li>
            </ul>
            
            <div class="nav-icons">
                <a href="cart.html" class="nav-icon">
                    üõí
                    <span id="cart-badge" class="cart-badge" style="display: none;">0</span>
                </a>
                <a href="login.html" id="login-link" class="nav-icon">üë§</a>
                <a href="#" id="user-link" class="nav-icon" style="display: none;" title="Profile">üë§</a>
                <button id="logout-btn" class="nav-icon" style="display: none; background: none; border: none; color: white; cursor: pointer;">Logout</button>
            </div>
            
            <button class="mobile-menu-btn">‚ò∞</button>
        </div>
    </nav>

    <!-- Checkout Section - Hidden until loaded -->
    <div class="container content-loading" id="checkout-content">
        <h1 class="section-title">Checkout</h1>
        <p class="section-subtitle">Complete your order with Cash on Delivery (COD)</p>

        <div class="cart-container">
            <!-- Checkout Form -->
            <div>
                <form id="checkout-form" class="form-container" style="max-width: 100%;">
                    <h2 style="margin-bottom: 30px; color: var(--primary-black);">Shipping Information</h2>

                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" id="full-name" class="form-input" placeholder="Enter your full name" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Phone Number *</label>
                        <input type="tel" id="phone-number" class="form-input" placeholder="+92 300 1234567" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Street Address *</label>
                        <input type="text" id="street-address" class="form-input" placeholder="House number and street name" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">City *</label>
                            <input type="text" id="city" class="form-input" placeholder="City" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Postal Code *</label>
                            <input type="text" id="postal-code" class="form-input" placeholder="Postal code" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">State/Province</label>
                        <input type="text" id="state" class="form-input" placeholder="State or Province">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Delivery Instructions (Optional)</label>
                        <textarea id="delivery-notes" class="form-textarea" placeholder="Any special instructions for delivery..."></textarea>
                    </div>

                    <div style="background: var(--light-gray); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;">üíµ Payment Method</h3>
                        <p style="color: var(--text-light); margin-bottom: 10px;">Cash on Delivery (COD)</p>
                        <p style="font-size: 0.9em; color: var(--text-light);">You will pay in cash when your order is delivered to your address.</p>
                    </div>

                    <button type="submit" class="btn-primary" style="font-size: 1.2em; padding: 15px;">
                        Place Order
                    </button>

                    <a href="cart.html" class="btn-secondary mt-20" style="width: 100%; text-align: center;">
                        ‚Üê Back to Cart
                    </a>
                </form>
            </div>

            <!-- Order Summary -->
            <div class="cart-summary">
                <h2>Order Summary</h2>
                
                <div id="order-items-summary">
                    <!-- Order items will be loaded here -->
                </div>

                <div class="summary-row" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-gray);">
                    <span>Subtotal:</span>
                    <span id="subtotal-amount">$0.00</span>
                </div>
                
                <div class="summary-row">
                    <span>Shipping:</span>
                    <span>FREE</span>
                </div>
                
                <div class="summary-total">
                    <span>Total:</span>
                    <span id="total-amount">$0.00</span>
                </div>

                <div class="alert alert-info mt-20" style="font-size: 0.9em;">
                    <span>‚ÑπÔ∏è</span>
                    <span>You will pay <strong>cash on delivery</strong> when your order arrives.</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="index.html">Home</a>
                <a href="products.html">Products</a>
                <a href="orders.html">My Orders</a>
                <a href="cart.html">Cart</a>
                <a href="login.html">Login</a>
            </div>
            <p>&copy; 2024 ShopHub. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="api.js"></script>
    <script>
        let cartData = null;

        // Hide page loading overlay
        function hidePageLoading() {
            const overlay = document.getElementById('page-loading');
            const content = document.getElementById('checkout-content');
            
            if (overlay) {
                overlay.classList.add('fade-out');
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 300);
            }
            
            if (content) {
                content.classList.remove('content-loading');
                content.classList.add('content-loaded');
            }
        }

        // Show page loading overlay
        function showPageLoading(message = 'Loading...', subtext = '') {
            const overlay = document.getElementById('page-loading');
            if (overlay) {
                overlay.style.display = 'flex';
                overlay.classList.remove('fade-out');
                
                const loadingText = overlay.querySelector('.loading-text');
                const loadingSubtext = overlay.querySelector('.loading-subtext');
                
                if (loadingText) loadingText.textContent = message;
                if (loadingSubtext) loadingSubtext.textContent = subtext;
            }
        }

        // Load cart summary
        async function loadCartSummary() {
            console.log('üîÑ Loading cart summary...');
            
            if (!checkAuth()) {
                hidePageLoading();
                return;
            }

            const userId = await getCurrentUserId();

            try {
                // Wait for API_ENDPOINTS
                let attempts = 0;
                while (typeof API_ENDPOINTS === 'undefined' && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (typeof API_ENDPOINTS === 'undefined') {
                    throw new Error('API_ENDPOINTS not available');
                }
                
                const response = await fetch(`${API_ENDPOINTS.VIEW_CART}?user_id=${userId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch cart');
                }

                cartData = await response.json();

                if (!cartData || !cartData.items || cartData.items.length === 0) {
                    hidePageLoading();
                    showAlert('Your cart is empty. Redirecting to products...', 'error');
                    setTimeout(() => {
                        window.location.href = 'products.html';
                    }, 2000);
                    return;
                }

                displayOrderSummary();
                
                // Hide loading overlay after everything is rendered
                setTimeout(() => {
                    hidePageLoading();
                }, 500);

            } catch (error) {
                console.error('Error loading cart:', error);
                hidePageLoading();
                showAlert('Failed to load cart. Please try again.', 'error');
            }
        }

        // Display order summary
        function displayOrderSummary() {
            const itemsContainer = document.getElementById('order-items-summary');
            const cartTotal = cartData.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            itemsContainer.innerHTML = cartData.items.map(item => {
                const subtotal = item.price * item.quantity;
                return `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-gray);">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">${item.name}</div>
                            <div style="font-size: 0.9em; color: var(--text-light);">
                                Qty: ${item.quantity} √ó ${formatPrice(item.price)}
                            </div>
                        </div>
                        <div style="font-weight: bold;">
                            ${formatPrice(subtotal)}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('subtotal-amount').textContent = formatPrice(cartTotal);
            document.getElementById('total-amount').textContent = formatPrice(cartTotal);
        }

        // Handle checkout form submission
        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate form
            const fullName = document.getElementById('full-name').value.trim();
            const phoneNumber = document.getElementById('phone-number').value.trim();
            const streetAddress = document.getElementById('street-address').value.trim();
            const city = document.getElementById('city').value.trim();
            const postalCode = document.getElementById('postal-code').value.trim();
            const state = document.getElementById('state').value.trim();
            const deliveryNotes = document.getElementById('delivery-notes').value.trim();

            if (!fullName || !phoneNumber || !streetAddress || !city || !postalCode) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            // Validate phone number
            if (!validatePhone(phoneNumber)) {
                showAlert('Please enter a valid phone number', 'error');
                return;
            }

            // Prepare order data
            const userId = await getCurrentUserId();
            const orderData = {
                user_id: userId,
                shipping_address: {
                    full_name: fullName,
                    street: streetAddress,
                    city: city,
                    state: state,
                    postal_code: postalCode
                },
                phone_number: phoneNumber,
                notes: deliveryNotes
            };

            // Get submit button
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            // Add loading state to button
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing Order...';

            try {
                const response = await fetch(API_ENDPOINTS.PLACE_ORDER, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Order placed successfully!', 'success');
                    
                    // Redirect to order confirmation page
                    setTimeout(() => {
                        window.location.href = `order-confirmation.html?order_id=${result.order_id}&order_number=${result.order_number}`;
                    }, 1500);
                } else {
                    throw new Error(result.message || 'Unknown error');
                }

            } catch (error) {
                console.error('Error placing order:', error);
                showAlert('Failed to place order: ' + error.message, 'error');
                
                // Remove loading state
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Load cart summary when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('üìÑ DOM loaded, loading cart summary...');
                loadCartSummary();
            });
        } else {
            console.log('üìÑ DOM already loaded, loading cart summary immediately...');
            loadCartSummary();
        }
    </script>
    <script src="chatbot.js"></script>
</body>
</html>