<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback - ShopHub</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="chatbot.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">üõçÔ∏è ShopHub</a>
            
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="products.html">Products</a></li>
                <li><a href="orders.html">My Orders</a></li>
            </ul>
            
            <div class="nav-icons">
                <a href="cart.html" class="nav-icon">
                    üõí
                    <span id="cart-badge" class="cart-badge" style="display: none;">0</span>
                </a>
                <a href="login.html" id="login-link" class="nav-icon">üë§</a>
                <a href="#" id="user-link" class="nav-icon" style="display: none;" title="Profile">üë§</a>
                <button id="logout-btn" class="nav-icon" style="display: none; background: none; border: none; color: white; cursor: pointer;">Logout</button>
            </div>
            
            <button class="mobile-menu-btn">‚ò∞</button>
        </div>
    </nav>

    <!-- Feedback Section -->
    <div class="container">
        <div class="form-container">
            <h1 style="text-align: center; margin-bottom: 10px;">Share Your Feedback</h1>
            <p style="text-align: center; color: var(--text-light); margin-bottom: 40px;">
                We value your opinion! Help us improve your shopping experience.
            </p>

            <form id="feedback-form">
                <!-- Feedback Type -->
                <div class="form-group">
                    <label class="form-label">Feedback Type *</label>
                    <select id="feedback-type" class="form-select" required>
                        <option value="">Select feedback type...</option>
                        <option value="Order">Order</option>
                        <option value="Product">Product</option>
                        <option value="Experience">Experience</option>
                        <option value="Support">Support</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <!-- Rating -->
                <div class="form-group">
                    <label class="form-label">Rating *</label>
                    <select id="rating" class="form-select" required>
                        <option value="">Select rating...</option>
                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 - Excellent)</option>
                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 - Good)</option>
                        <option value="3">‚≠ê‚≠ê‚≠ê (3 - Average)</option>
                        <option value="2">‚≠ê‚≠ê (2 - Below Average)</option>
                        <option value="1">‚≠ê (1 - Poor)</option>
                    </select>
                </div>

                <!-- Comment -->
                <div class="form-group">
                    <label class="form-label">Your Feedback *</label>
                    <textarea 
                        id="comment" 
                        class="form-textarea" 
                        placeholder="Please share your thoughts, concerns, or experience..."
                        required
                        minlength="10"
                        style="min-height: 150px;"
                    ></textarea>
                    <small style="color: var(--text-light); font-size: 0.85em;">
                        Minimum 10 characters
                    </small>
                </div>

                <!-- Optional Suggestion -->
                <div class="form-group">
                    <label class="form-label">Any suggestion for improvement?</label>
                    <input 
                        type="text" 
                        id="suggestion" 
                        class="form-input" 
                        placeholder="Optional: Share any ideas or suggestions..."
                    >
                </div>

                <div class="alert alert-info mb-20">
                    <span>‚ÑπÔ∏è</span>
                    <span>Your feedback helps us serve you better. Thank you for taking the time!</span>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn-primary" style="font-size: 1.1em;">
                    Submit Feedback
                </button>

                <div class="mt-20">
                    <a href="index.html" class="btn-secondary" style="width: 100%; text-align: center;">
                        ‚Üê Back to Home
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="index.html">Home</a>
                <a href="products.html">Products</a>
                <a href="orders.html">My Orders</a>
                <a href="cart.html">Cart</a>
                <a href="login.html">Login</a>
            </div>
            <p>&copy; 2024 ShopHub. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="api.js"></script>
    <script>
        console.log('üìù Feedback page loaded');

        // N8N Webhook URL - Replace with your actual webhook URL
        const FEEDBACK_WEBHOOK_URL = 'https://team4n8n.app.n8n.cloud/webhook/get_feedback';

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üîí Checking authentication...');
            
            // Use existing auth check function from api.js
            const isAuthenticated = await checkAuth(true);
            
            if (!isAuthenticated) {
                // User will be redirected by checkAuth function
                console.log('‚ùå Not authenticated, redirecting...');
                return;
            }
            
            console.log('‚úÖ User authenticated, feedback form ready');
        });

        // Handle feedback form submission
        document.getElementById('feedback-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('üì§ Feedback form submitted');

            // Get form values
            const feedbackType = document.getElementById('feedback-type').value.trim();
            const rating = document.getElementById('rating').value;
            const comment = document.getElementById('comment').value.trim();
            const suggestion = document.getElementById('suggestion').value.trim();

            // Validate required fields
            if (!feedbackType || !rating || !comment) {
                showAlert('Please fill in all required fields', 'error');
                console.log('‚ùå Validation failed: Missing required fields');
                return;
            }

            // Validate comment minimum length
            if (comment.length < 10) {
                showAlert('Feedback comment must be at least 10 characters long', 'error');
                console.log('‚ùå Validation failed: Comment too short');
                return;
            }

            // Get user information from existing auth system
            let userId = null;
            let userEmail = null;

            try {
                userId = await getCurrentUserId();
                const user = await getCurrentUser();
                userEmail = user?.email || null;

                console.log('üë§ User info:', { userId, userEmail });

                if (!userId || !userEmail) {
                    showAlert('Unable to retrieve user information. Please try logging in again.', 'error');
                    console.error('‚ùå Missing user information');
                    return;
                }
            } catch (error) {
                console.error('‚ùå Error getting user info:', error);
                showAlert('Unable to retrieve user information. Please try logging in again.', 'error');
                return;
            }

            // Disable submit button to prevent double submission
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            // Prepare feedback payload
            const feedbackData = {
                feedback_type: feedbackType,
                rating: parseInt(rating),
                comment: comment,
                suggestion: suggestion || null,
                user_id: userId,
                email: userEmail,
                submitted_at: new Date().toISOString()
            };

            console.log('üì¶ Feedback payload:', feedbackData);

            try {
                // Check if webhook URL is configured
                if (FEEDBACK_WEBHOOK_URL === 'https://YOUR_N8N_WEBHOOK_URL_HERE') {
                    console.warn('‚ö†Ô∏è Webhook URL not configured');
                    showAlert('Feedback system is not yet configured. Please contact support.', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }

                // Send feedback to n8n webhook
                const response = await fetch(FEEDBACK_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(feedbackData)
                });

                console.log('üì• Response status:', response.status);

                // Check response
                if (!response.ok) {
                    throw new Error(`Webhook error: ${response.status} ${response.statusText}`);
                }

                // Success
                console.log('‚úÖ Feedback submitted successfully');
                showAlert('‚úÖ Thank you for your feedback! We appreciate your input.', 'success');

                // Reset form after successful submission
                e.target.reset();

                // Optional: Redirect to home page after a delay
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);

            } catch (error) {
                console.error('‚ùå Error submitting feedback:', error);
                
                // User-friendly error message
                showAlert('Failed to submit feedback. Please try again later.', 'error');
                
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Character counter for comment field (optional enhancement)
        document.getElementById('comment').addEventListener('input', function() {
            const minLength = 10;
            const currentLength = this.value.length;
            
            if (currentLength > 0 && currentLength < minLength) {
                this.style.borderColor = '#ffc107';
            } else if (currentLength >= minLength) {
                this.style.borderColor = '#28a745';
            } else {
                this.style.borderColor = '#e0e0e0';
            }
        });
    </script>

    <!-- Load chatbot -->
    <script src="chatbot.js"></script>
</body>

</html>
