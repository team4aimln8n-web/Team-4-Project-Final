<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - ShopHub</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- 
    ==========================================
    STEP 1: Add Supabase JS Library
    ==========================================
    This CDN link loads the Supabase client library
    -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">üõçÔ∏è ShopHub</a>
            
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="products.html">Products</a></li>
                <li><a href="orders.html">My Orders</a></li>
            </ul>
            
            <div class="nav-icons">
                <a href="cart.html" class="nav-icon">
                    üõí
                    <span id="cart-badge" class="cart-badge" style="display: none;">0</span>
                </a>
                <a href="login.html" id="login-link" class="nav-icon">üë§</a>
                <a href="#" id="user-link" class="nav-icon" style="display: none;" title="Profile">üë§</a>
                <button id="logout-btn" class="nav-icon" style="display: none; background: none; border: none; color: white; cursor: pointer;">Logout</button>
            </div>
            
            <button class="mobile-menu-btn">‚ò∞</button>
        </div>
    </nav>

    <!-- Login Section -->
    <div class="container">
        <div class="form-container">
            <h1 style="text-align: center; margin-bottom: 10px;">Welcome Back</h1>
            <p style="text-align: center; color: var(--text-light); margin-bottom: 40px;">
                Login to your account to continue shopping
            </p>

            <form id="login-form">
                <div class="form-group">
                    <label class="form-label">Email Address *</label>
                    <input type="email" id="email" class="form-input" placeholder="Enter your email" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Password *</label>
                    <input type="password" id="password" class="form-input" placeholder="Enter your password" required>
                </div>

                <button type="submit" class="btn-primary" style="font-size: 1.1em;">
                    Login
                </button>
            </form>

            <div style="text-align: center; margin-top: 30px; padding-top: 30px; border-top: 1px solid var(--border-gray);">
                <p style="color: var(--text-light); margin-bottom: 15px;">
                    Don't have an account?
                </p>
                <a href="register.html" class="btn-secondary" style="display: inline-block; width: auto;">
                    Create Account
                </a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="index.html">Home</a>
                <a href="products.html">Products</a>
                <a href="orders.html">My Orders</a>
                <a href="cart.html">Cart</a>
                <a href="login.html">Login</a>
            </div>
            <p>&copy; 2024 ShopHub. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="api.js"></script>
    <script>
        // ==========================================
        // STEP 2: Initialize Supabase Client
        // ==========================================
        // Replace these with your actual Supabase project credentials
        // Find them in: Supabase Dashboard > Project Settings > API
        


        // ==========================================
        // STEP 3: Handle Login Form Submission
        // ==========================================
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            // Validate inputs
            if (!email || !password) {
                showAlert('Please fill in all fields', 'error');
                return;
            }

            if (!validateEmail(email)) {
                showAlert('Please enter a valid email address', 'error');
                return;
            }

            // Disable submit button
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Logging in...';

            try {
                // ==========================================
                // STEP 4: Authenticate with Supabase
                // ==========================================
                // This method verifies email/password with Supabase Auth
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                // Check for errors
                if (error) {
                    throw new Error(error.message);
                }

                // Check if user exists
                if (!data.user) {
                    throw new Error('Login failed. Please check your credentials.');
                }

                // ==========================================
                // STEP 5: Save User Session
                // ==========================================
                // Save user ID and email to localStorage for easy access
                // Supabase also stores the session token automatically
                saveUserId(data.user.id);
                localStorage.setItem('user_email', data.user.email);

                // Optional: Save additional user metadata if available
                if (data.user.user_metadata && data.user.user_metadata.full_name) {
                    localStorage.setItem('user_name', data.user.user_metadata.full_name);
                }

                showAlert('Login successful! Redirecting...', 'success');

                // ==========================================
                // STEP 6: Redirect User
                // ==========================================
                // Redirect to previous page or home
                setTimeout(() => {
                    const redirectUrl = new URLSearchParams(window.location.search).get('redirect') || 'index.html';
                    window.location.href = redirectUrl;
                }, 1500);

            } catch (error) {
                console.error('Login error:', error);
                
                // User-friendly error messages
                let errorMessage = 'Login failed. Please try again.';
                
                if (error.message.includes('Invalid login credentials')) {
                    errorMessage = 'Invalid email or password. Please check your credentials.';
                } else if (error.message.includes('Email not confirmed')) {
                    errorMessage = 'Please verify your email address before logging in.';
                } else if (error.message.includes('network')) {
                    errorMessage = 'Network error. Please check your connection.';
                } else {
                    errorMessage = error.message;
                }
                
                showAlert(errorMessage, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Login';
            }
        });

        // ==========================================
        // STEP 7: Check if User Already Logged In
        // ==========================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Check Supabase session
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                // User is already logged in, redirect to home
                window.location.href = 'index.html';
            }
        });

        // ==========================================
        // ADDITIONAL FEATURES (Optional)
        // ==========================================
        
        // Forgot Password functionality (if you want to add it)
        /*
        async function handleForgotPassword() {
            const email = document.getElementById('email').value.trim();
            
            if (!email) {
                showAlert('Please enter your email address', 'error');
                return;
            }
            
            const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.origin + '/reset-password.html'
            });
            
            if (error) {
                showAlert('Failed to send reset email: ' + error.message, 'error');
            } else {
                showAlert('Password reset email sent! Check your inbox.', 'success');
            }
        }
        */
    </script>

    <!-- 
    ==========================================
    CONFIGURATION CHECKLIST
    ==========================================
    
    ‚úÖ 1. Get your Supabase credentials:
       - Go to: https://supabase.com/dashboard
       - Select your project
       - Go to: Project Settings > API
       - Copy "Project URL" and "anon/public key"
    
    ‚úÖ 2. Replace credentials above:
       - SUPABASE_URL: Your project URL
       - SUPABASE_ANON_KEY: Your anon public key
    
    ‚úÖ 3. Enable Email Auth in Supabase:
       - Go to: Authentication > Providers
       - Enable "Email" provider
       - Configure email templates (optional)
    
    ‚úÖ 4. Configure Email Settings (optional):
       - Go to: Authentication > Email Templates
       - Customize confirmation and recovery emails
    
    ‚úÖ 5. Set up redirect URLs (optional):
       - Go to: Authentication > URL Configuration
       - Add your site URL to allowed redirect URLs
    
    ==========================================
    SECURITY NOTES
    ==========================================
    
    ‚úì The anon key is SAFE to use in frontend code
    ‚úì Supabase handles password hashing automatically
    ‚úì Row Level Security (RLS) in database protects user data
    ‚úì Session tokens are stored securely by Supabase
    ‚úì All requests are made over HTTPS
    
    ==========================================
    TESTING
    ==========================================
    
    1. Create a test user in Supabase Dashboard:
       - Go to: Authentication > Users
       - Click "Add User"
       - Or register through register.html
    
    2. Test login with that user
    
    3. Check browser DevTools > Application > Local Storage
       - Should see Supabase session data
    
    ==========================================
    -->
</body>
</html>